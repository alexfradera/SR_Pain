---
title: "Search terms"
author: "Alex Fradera"
date: "15/06/2021"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Using litsearchr
```{r install litsearchr}
library(litsearchr)
packageVersion("litsearchr")
```


## Completing the naive search

I put into PubMed pain* AND cognit* and screen* which produced 949 results.
I then put this into litsearchr

```{r naiveresults}
naive_results <- import_results(file="pubmed-painANDcog-set.nbib")
nrow(naive_results)
```
## Collating search keywords
We can then have a look at the keywords - here limited to those that appear in 3 or more papers

```{r get_keywords}
keywords <- extract_terms(keywords=naive_results[, "keywords"], method="tagged", min_n=1, min_freq = 3)
```

## Collating search title content

A bit more to do here as titles can contain many "stopwords" that are not informative to the topic of the article. I have begun to build a tentative stopword list at SR_stopwords.txt 

```{r create_stops}
SR_stopwords <- read_lines("SR_stopwords.txt")
all_stopwords <- c(get_stopwords("English"), SR_stopwords)

```

```{r get_best_titles}
title_terms <- extract_terms(
  text=naive_results[, "title"],
  method="fakerake",
  min_freq=3, min_n=2,
  stopwords=all_stopwords
)

title_terms
```

We can combine these useful title terms with keywords, removing duplicates:
```{r combined_terms}
terms <- unique(c(keywords, title_terms))
```


### Network analysis of content
```{r create_network}
docs <- paste(naive_results[, "title"], naive_results[, "abstract"])
dfm <- create_dfm(elements=docs, features=terms)
g <- create_network(dfm, min_studies=1)

```

We can now visualise this:

```{r vis_network}

library(ggraph)
network_vis<-ggraph(g, layout="stress") +
     coord_fixed() +
     expand_limits(x=c(-3, 3)) +
     geom_edge_link(aes(alpha=weight)) +
     geom_node_point(shape="circle filled", fill="white") +
     geom_node_text(aes(label=name), hjust="outward", check_overlap=TRUE) +
     guides(edge_alpha=FALSE)
```

And find the strongest links in the network

```{r network_strengths}
library(igraph)
strengths <- strength(g)

data.frame(term=names(strengths), strength=strengths, row.names=NULL) %>%
  mutate(rank=rank(strength, ties.method="min")) %>%
  arrange(strength) ->
  term_strengths

term_strengths
```


```{r network_cutoffs}
cutoff_fig <- ggplot(term_strengths, aes(x=rank, y=strength, label=term)) +
  geom_line() +
  geom_point() +
  geom_text(data=filter(term_strengths, rank>5), hjust="right", nudge_y=20, check_overlap=TRUE)

cutoff_change <- find_cutoff(g, method="changepoint", knot_num=3)

cutoff_fig +
  geom_hline(yintercept=cutoff_change, linetype="dashed")

```


```{r}
g_redux <- reduce_graph(g, cutoff_change[1]) # tweak this number to change the cutoff option
selected_terms <- get_keywords(g_redux)

selected_terms
```

















# Population search terms
Not sure about this: do we need to specify Adult or just use in exclusion criteria?


```{r preview, include=FALSE}
library(readr)
input_file <- "cog_screens.csv"
x <- spec_csv(input_file) # good practice to peek before reading in
x

```

```{r load_file, include=FALSE}
cog_screens <- read_csv(input_file
                     )
```






# Pain search terms


# Cognitive screen search terms

```{r make_abbreviation_vector, include=FALSE}
library(dplyr)
abbrevsonly <- filter(cog_screens, cog_screens$Abbreviation != "to complete")
```







## Raw search terms


Based on all the cognitive screens in the .csv file, we would need to search for these test names and referents.

```{r text_list, include=TRUE}
library(stringr)

screen_full_names<- str_flatten(cog_screens$Test_Name,"\" OR \"")
screen_abbreviations<- str_flatten(abbrevsonly$Abbreviation,"\" OR \"")
screen_referents <- str_c("\"", screen_full_names, "\" OR \"", screen_abbreviations, "\"")
 writeLines(screen_referents)

```
In other words:

`r screen_referents`


*Note:* in fact some of the screeners names will need to be amended with wildcards.

## Putting search terms into readable contexts

### EBSCO Host

```{r}
s_screen_title <-  str_c("TI (",screen_referents,")")
s_screen_abstract <-  str_c("AB (",screen_referents,")")
  s_screen_testmeasures <- <-  str_c("TM (",screen_referents,")")

```

